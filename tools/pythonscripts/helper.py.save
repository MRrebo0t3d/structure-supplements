import random
def generateBulkYaml(structureFile, templateFile, numConfigs):
    atoms = getAtoms(structureFile)
    possibleEnds = getBestAtoms(atoms)
    pairs = getPairs(possibleEnds, numConfigs)

    templateString = readFile(templateFile)

    for i, pair in pairs:
        configFileName = "config"+str(1+i)+'.yaml'
        start = pair[0]['atomName']
        end   = pair[1]['atomName']
        writeOutData = [structureFile, start, end]
        writeOutYamlFile(configFileName, templateString, packedData)



def readFile(templateFile):
    with open(templateFile, 'r') as infile:
       return infile.read()


def getAtoms(structureFile):
    atomNum = 0;
    atoms = []
    with open(structureFile, 'r') as infile:
        atomNum = 0;
        for line in infile:
            arr = line.split()
            if len(arr) != 16:
                continue;
            atomNum += 1
            atomName = arr[3]
            atom = {'atomName': atomName+str(atomNum), 'x': float(arr[0]), 'y': float(arr[1]), 'z':float(arr[2])}
            atoms.append(atom)
    return atoms


def writeOutYamlFile(fileName, templateString, packedData):
    fileOutput = templateString.format(*packedData)
    with open(fileName, 'w') as outfile:
        outfile.write(fileOutput)


def getBestAtoms(atoms):
    atomBest = []
    for var in ('x','y','z'):
        atomBest += getMinMax(atoms,var)
    return atomBest


def getMinMax(atoms, var):
    sortedAtoms = list(sorted(atoms,key=lambda atom: atom[var]))
    minMax = [sortedAtoms[0], sortedAtoms[len(sortedAtoms)-1]]
    return minMax


def getPairs(bestAtoms, numConfigs):
    pairs = []
    for i in range(numConfigs):
        start = random.choice(bestAtoms)
        end = random.choice(bestAtoms)
        while end is start:
            end = random.choice(bestAtoms)
        while (start, end) in pairs or (end,start) in pairs:
            end = random.choice(bestAtoms)
        pairs.append((start,end))


import sys
switch = sys.argv[1]
structureFile = sys.argv[2]
templateFile = sys.argv[3]

if switch == 'rapid':
    startAtom = sys.argv[4]
    endAtom = sys.argv[5]
    outputFile = sys.argv[6]
    templateString = readFile(templateFile)
    packedData = [structureFile, startAtom, endAtom]
    writeOutYamlFile(outputFile,templateString, packedData)
elif switch == 'test':
    templateString = readFile(templateFile)
    packedData = [structureFile]
    writeOutYamlFile('project.yaml', templateString, packedData)
else:
    numConfigs = int(sys.argv[4])
    generateBulkYaml(structureFile, templateFile, numConfigs)
